<section class="py-4">
  <div class="d-flex justify-content-start mb-2">
    <a class="btn btn-sm btn-outline-secondary" href="/dashboard"><i class="fa-solid fa-arrow-left me-1"></i> Rudi
      Dashboard</a>
  </div>
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card sb-card">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <span class="sb-hero-icon sb-hero-success me-2"><i class="fa-solid fa-circle-plus"></i></span>
            <h1 class="h5 mb-0">Ongeza Salio</h1>
          </div>
          <div class="mb-3">Salio la sasa: <span id="balance-amount">TZS <%= Number((user && user.balance) ||
                0).toLocaleString('en-US') %></span></div>
          <form id="add-funds-form" class="sb-form" novalidate hx-post="/zeno/pay" hx-target="#paymentModalBody" hx-swap="innerHTML" hx-disabled-elt="input, button" hx-indicator="#af-spinner" data-open-modal="globalPaymentModal">
            <div class="mb-3">
              <label class="form-label" for="payPhone">Namba Yako ya Simu</label>
              <div class="input-group sb-input-group">
                <span class="input-group-text">+255</span>
                <input type="text" class="form-control" id="payPhone" name="phone9" inputmode="numeric" pattern="[1-9][0-9]{8}" minlength="9" maxlength="9" placeholder="Mfano: 712345678" required aria-describedby="phone9-help phone9-feedback" aria-invalid="false">
              </div>
              <div id="phone9-help" class="form-text">Weka tarakimu 9 bila kuanza na 0</div>
              <div id="phone9-feedback" class="invalid-feedback" aria-live="polite"></div>
            </div>
            <div class="mb-3">
              <label class="form-label" for="amount">Kiasi (TZS)</label>
              <input type="number" class="form-control" id="amount" name="amount" min="500" step="1" required>
              <div class="form-text">Weka kiasi unachotaka kuongeza</div>
            </div>
            <div class="d-flex justify-content-end gap-2">
              <button class="btn btn-success" type="submit" data-bs-toggle="modal" data-bs-target="#globalPaymentModal">
                <span class="sb-btn-label"><i class="fa-solid fa-plus me-1"></i> Ongeza</span>
                <span id="af-spinner" class="htmx-indicator spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card sb-card">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <span class="sb-hero-icon sb-hero-primary me-2"><i class="fa-solid fa-receipt"></i></span>
            <h2 class="h6 mb-0">Miamala 10 ya Mwisho</h2>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Tarehe</th>
                  <th>Aina</th>
                  <th>Kiasi</th>
                </tr>
              </thead>
              <tbody>
                <% if (!transactions || transactions.length===0) { %>
                <tr>
                  <td colspan="5" class="text-center text-muted">Hakuna miamala bado.</td>
                </tr>
                <% } else { %>
                <% transactions.forEach(function(t){ %>
                <tr>
                  <td>
                    <%= new Date(t.createdAt).toLocaleString('en-GB') %>
                  </td>
                  <td>
                    <span class="badge bg-<%= t.type === 'credit' ? 'success' : 'danger' %>">
                      <%= t.type %>
                    </span>
                  </td>
                  <td>TZS <%= Number(t.amount).toLocaleString('en-US') %>
                  </td>
                </tr>
                <% }) %>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>



<!-- Global Payment Modal (shared by HTMX fragments) -->
<div class="modal fade" id="globalPaymentModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 id="paymentModalTitle" class="modal-title">
          <i class="fa-solid fa-wallet me-1"></i> Malipo Tanzania ðŸ‡¹ðŸ‡¿
        </h5>
      </div>
      <div id="paymentModalBody" class="modal-body">
        <!-- HTMX will inject the payment form here -->
        <div class="d-flex justify-content-center align-items-center">
          <div class="spinner-border text-dark mx-auto" role="status" style="height: 3rem; width: 3rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
      <div id="paymentModalFooter" class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="fa-regular fa-circle-xmark me-1"></i>
          Funga
        </button>
      </div>
    </div>
  </div>
</div>



<script>
  // Minimal HTMX helper: reset modal when submitting HTMX forms to avoid stale contents
  (function() {
    document.addEventListener('htmx:beforeRequest', function(evt) {
      var form = evt.target.closest('form');
      try {
        var modalId = form && form.getAttribute('data-open-modal');
        if (modalId && window.bootstrap) {
          var el = document.getElementById(modalId);
          if (el) {
            var title = document.getElementById('paymentModalTitle');
            var body = document.getElementById('paymentModalBody');
            var footer = document.getElementById('paymentModalFooter');
            if (title) title.textContent = 'Malipo Tanzania ðŸ‡¹ðŸ‡¿';
            if (body) body.innerHTML = '<div class="d-flex justify-content-center align-items-center"><div class="spinner-border text-dark mx-auto" role="status" style="height: 3rem; width: 3rem;"><span class="visually-hidden">Loading...</span></div></div>';
            if (footer) footer.innerHTML = '<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"><i class="fa-regular fa-circle-xmark me-1"></i> Funga</button>';
          }
        }
      } catch (e) {}
    });
  })();
</script>